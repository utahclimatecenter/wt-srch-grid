<script src="../jquery/dist/jquery.min.js"></script>

<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../iron-ajax/iron-ajax.html">
<link rel="import" href="../paper-icon-button/paper-icon-button.html">
<link rel="import" href="../iron-icons/iron-icons.html">
<link rel="import" href="../iron-form/iron-form.html">
<link rel="import" href="../paper-input/paper-input.html">
<link rel="import" href="../paper-button/paper-button.html">
<link rel="import" href="../paper-dialog/paper-dialog.html">
<link rel="import" href="../paper-spinner/paper-spinner.html">
<link rel="import" href="../iron-form/iron-form.html">

<link rel="import" href="../wt-bootstrap-styles/wt-bootstrap-styles.html">
<link rel="import" href="../vaadin-grid/vaadin-grid.html">
<link rel="import" href="../vaadin-combo-box/vaadin-combo-box.html">
<link rel="import" href="../vaadin-grid/vaadin-grid-sorter.html">
<link rel="import" href="../wt-srch-bar/wt-srch-bar.html">
<link rel="import" href="../wt-vaadin-multi-combo/wt-vaadin-multi-combo.html">
<link rel="import" href="../wt-breadcrumb/wt-breadcrumb.html">


<!--
`<my-station>` Shows the vaadin grid in action with iron-ajax against the climate api.
In typical use, just slap some `<my-station>` anywhere you would like to put it.
      <my-station></my-station>
Wham! It's all awesome now!

@demo /web-components/drawer-app/#/station/list  Super cool demo!!
-->
<dom-module id="wt-srch-grid">
  <template>
    <style include="bootstrap-styles">
      :host {
        display: block;
        background-color: #ffffff;
        /*padding: 10px;*/
      }

      .clearfix:after {
          content: "";
          display: table;
          clear: both;
      }

      vaadin-grid#grid {

      font-family: Roboto, sans-serif;
      --divider-color: rgba(0, 0, 0, var(--dark-divider-opacity));


      --vaadin-grid-header-cell: {
        height: 54px;
        color: rgba(0, 0, 0, var(--dark-secondary-opacity));
        font-size: 12px;
      };

      --vaadin-grid-body-cell: {
        height: 100%;
        color: rgba(0, 0, 0, var(--dark-primary-opacity));
        font-size: 13px;
      };

      --vaadin-grid-body-row-hover-cell: {
        background-color: var(--paper-grey-200);
      };

      --vaadin-grid-body-row-selected-cell: {
        background-color: var(--paper-grey-100);
      };

      --vaadin-grid-cell: {
        width: 100%;
        display: inline-flex;
        justify-content: center;
        flex-direction: column;
        white-space: none;   /* This is important for variable height rows & resizing */
        overflow: hidden;
      }

    }

    paper-button.submit {
        background: #4285F4;
        color: white;
        margin-top: 10px 3px 3px 3px;
    }

    paper-button.delete {
    /*    background: #f7cdcd;*/
/*        background: #F93C11;
        color: white;*/
        background: white;
        color: gray;
        margin-top: 10px 3px 3px 3px;
    }

    .block-right {
      float: right;
      box-sizing: border-box;
    }

    .block-left {
      float: left;
      box-sizing: border-box;
    }

    paper-button.cancel {
        background: white;
        color: gray;
        margin-top: 10px 3px 3px 3px;
    }

    paper-dialog.colored {
      border: 2px solid;
      border-color: #ff0000;
      background-color: #f7cdcd;
      color: #ff0000;
      width: 350px;
    }


    .details {
      padding: 10px;
      margin: 10px;
      justify-content: flex-end;
      align-items: center;
      box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14);
      font-size: 15px;
    }

    .details2 {
      padding: 10px;
      margin: 10px;
      justify-content: flex-end;
      align-items: center;
      font-size: 15px;
    }

    .nowrap-initial {
      white-space: initial;
    }

    #close-dialog {
    width: 30px;
    height: 30px;
    position: absolute;
    right: -10px;
    top: -10px;
    background: white;
    border: 1px solid #ededed;
    border-radius: 50%;
    padding: 0;
    margin: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    box-shadow: 0 2px 2px 0 rgba(0, 0, 0, 0.14), 0 1px 5px 0 rgba(0, 0, 0, 0.12), 0 3px 1px -2px rgba(0, 0, 0, 0.2);
    }

    #pages {
      display: flex;
      flex-wrap: wrap;
      margin: 20px;
    }

    #pages > button {
      user-select: none;
      padding: 5px;
      margin: 0 5px;
      border-radius: 10%;
      border: 0;
      background: transparent;
      font: inherit;
      outline: none;
      cursor: pointer;
    }

    #pages > button:hover,
    #pages > button:focus {
      color: var(--default-primary-color);
      background-color: #eee;
    }

    #pages > button[selected] {
      font-weight: bold;
      color: white;
      background-color: var(--default-primary-color);
    }


/*    [hoverText]:hover::after {
      content: attr(hoverText);
      position: relative;
      right: 0;
      top: 0;
      transform: translate(0, -100%);
      background-color: #fff;
      border: solid 1px #ccc;
      padding: 5px;
    }*/

    </style>

    <iron-ajax
      id="ajax"
      url="{{url}}"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'
      on-response="_handleResponse"></iron-ajax>

    <iron-ajax
      id="column-ajax"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'></iron-ajax>

    <iron-ajax
      id="breadcrumb-ajax"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'></iron-ajax>

    <iron-ajax
      id="edit-ajax"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'></iron-ajax>

    <iron-ajax
      id="icon-ajax"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'></iron-ajax>

    <iron-ajax
      id="crud-ajax"
      headers='{"X-Requested-With": "XMLHttpRequest"}'
      handle-as="json"
      headers='{"Cache-control": "no-cache"}'></iron-ajax>

    <wt-srch-bar
      id="wt-srch-bar"
      search-label=""
      style="text-align: center"
      default-srch-char-min-ajax="{{wtSrchBarCharMinAjax}}"
      default-srch={{wtSrchBarDefaultSrch}}
      default-srch-label={{wtSrchBarDefaultSrchLabel}}
      filter-types-url="{{wtSrchBarFilterTypesUrl}}"
      start-date="{{startDate}}"
      end-date="{{endDate}}"
      hide-filter="{{wtSrchBarHideFilter}}"></wt-srch-bar>
      <center><paper-spinner style="" id="spinner"></paper-spinner></center>
      <wt-breadcrumb items={{breadcrumbArray}}></wt-breadcrumb>
          <paper-dialog id="addDialog" modal closed>
              <paper-icon-button id="close-dialog" icon="close" on-click="_handleAddCancel"  title="Close"></paper-icon-button>
            <div class="details2 clearfix">
            <center><h2>Add Record</h2></center>
            <br>
            <iron-form id="srch-grid-iron-form-add">
              <form method="get">
                <div id="add-div"></div>
                <template is="dom-if" if="[[_checkIfSlotExists()]]">
                  <slot id="custom-add-expand-slot" name="custom-add-expand-slot"></slot>
                </template>
                <div class="block">
                  <paper-button class="cancel" id="cancel" on-click="_handleAddCancel">Cancel</paper-button>
                  <paper-button class="submit" id="save" on-click="_handleAdd" type="submit">Add</paper-button>
                </div>
                </div>
              </form>
            </iron-form>
            <br>
          </paper-dialog>

          <vaadin-grid aria-label="Sorting Example" items="[[data]]" style="height: [[height]]" multi-sort="[[multiSort]]" id="grid" page-size="[[pageSize]]">

            <template class="row-details">
            <iron-form id="srch-grid-iron-form">
              <form method="get">
              <div class="details clearfix">
                <div class="row">
                  <template is="dom-if" if="[[!_checkIfSlotExists()]]">
                    <template id="repeater" is="dom-repeat" items="{{columnArray}}" as="column">
                      <div class="col-md-4 nowrap-initial" id="[[column.name]]-editdiv""></div>
                    </template>
                  </template>
                  <template is="dom-if" if="[[_checkIfSlotExists()]]">
                    <slot id="custom-edit-expand-slot" name="custom-edit-expand-slot"></slot>
                  </template>
                </div>
                <br>
                <div class="block-left">
                <paper-button class="delete" id="save" class="clearfix" on-click="_areYouSure" type="submit">Delete</paper-button>
                </div>
                <div class="block-right">
                  <paper-button class="cancel" id="cancel" on-click="_handleCancel">Cancel</paper-button>
                  <paper-button class="submit" id="save" on-click="_handleSave" type="submit">Save</paper-button>
                </div>
              </div>
              </form>
            </iron-form>
            </template>

            <template id="repeater" is="dom-repeat" items="{{columnArray}}" as="column">

              <vaadin-grid-column>
                <template class="header">
                  <div id="[[column.name]]-header">
                      <vaadin-grid-sorter  path="{{column.name}}" direction="{{column.sort}}">{{column.description}}</vaadin-grid-sorter>
                  </div>
                </template>

                <template is="dom-if" if="[[_checkHref(column.href)]]">
                    <template>
                      <a title="" id="[[column.name]]-[[item.__edit_unique_id__]]" href="[[column.href]]/#/[[_getHashPath(column, item)]]" target="_self">{{_getItemValue(column, item)}}</a>
                    </template>
                </template>
                <template is="dom-if" if="[[!_checkHref(column.href)]]">
                  <template>
                    <template is="dom-if" if="[[_checkIconAction(column.icon_action)]]">
                      <paper-icon-button id="action-[[item.__edit_unique_id__]]" icon="[[item.icon]]" on-click="_iconClicked"></paper-icon-button>
                    </template>
                    <template is="dom-if" if="[[!_checkIconAction(column.icon_action)]]">
                      <div title="" id="[[column.name]]-[[item.__edit_unique_id__]]">{{_getItemValue(column, item)}}</div>
                    </template>
                  </template>
                </template>
              </vaadin-grid-column>

            </template>

            <vaadin-grid-column id="edit-button-[[item.__edit_unique_id__]]" width="40px" flex-grow="0">
              <template class="header">
                <paper-icon-button id="add" icon="add" hidden=[[!allowAdd]] on-click="_addClick" style="color: black; width: 25px; height: 25px; font-size: 0.8em; position: absolute; top: 0px; right: 0px;" title="Add"></paper-icon-button>
              </template>
              <template>
                <paper-icon-button id="edit-[[item.__edit_unique_id__]]" icon="create" hidden=[[!item.__edit_unique_id__]] on-click="_editClick" style="width: 20px; height: 20px; font-size: 0.8em; position: absolute; top: 0px; right: 0px;" title="Edit"></paper-icon-button>
              </template>
            </vaadin-grid-column>

          </vaadin-grid>
          <div id="pages" style="display: none">
            <button on-click="_prev">&lt;</button>
            <template is="dom-repeat" items="[[pages]]">
                <button hoverText="blah" on-click="_select" selected$="[[_isSelected(page, item)]]">[[item]]</button>
            </template>
            <button on-click="_next">&gt;</button>
          </div>
      <br>

      <paper-dialog id="errorDialog" class="colored" closed>
        <paper-icon-button id="close-dialog" icon="close" on-click="_handleErrClose"  title="Close"></paper-icon-button>
        <center><h2>ERROR</h2></center>
        <div id="error-content"></div>
      </paper-dialog>

      <paper-dialog id="areYouSureDialog" modal closed>
        <paper-icon-button id="close-dialog" icon="close" on-click="_handleAreYouSureCancel"  title="Yes"></paper-icon-button>
        <center><h2>Are you Sure?</h2></center>
        <div id="are-you-sure-content" class="details2 clearfix"></div>
        <div class="block-right">
          <paper-button class="cancel" id="cancel" on-click="_handleAreYouSureCancel">No</paper-button>
          <paper-button class="submit" id="save" on-click="_handleAreYouSureSave" type="submit">Yes</paper-button>
        </div>
      </paper-dialog>

  </template>
  <script>
        /**
     * @customElement
     * @polymer
     */
    class WtSrchGrid extends Polymer.Element {
      static get is() { return 'wt-srch-grid'; }

      static get properties() {
        return {
            url: String,
            autoLoadUrl: {
              type: String,
              value: "false"
            },
            uniqueName: String,
            title: String,
            gridHeight: {
              type: String,
              value: "600px"
            },
            groupBy: {
                type: Array,
                value: [],
                reflectToAttribute: true
            },
            wtSrchBarFilterTypesUrl: String,
            wtSrchBarDefaultSrch: String,
            wtSrchBarDefaultSrchLabel: String,
            wtSrchBarCharMinAjax: String,
            wtSrchBarHideFilter: {
              type: String,
              value: "false"
            },
            columnArrayUrl: {
              type: String,
              value: null
            },
            columnArray: {
                type: Array,
                value: [],
                reflectToAttribute: true,
                notify: true,                 // A notifying property supports upward data flow.
                                              //  By default, properties are non-notifying, and
                                              //  don't support upward data flow.

                readOnly: false               // A read-only property prevents downward data flow.
                                              //  By default, properties are read/write, and
                                              //  support downward data flow

                // See:  https://www.polymer-project.org/2.0/docs/devguide/data-system#make-observable-changes  -- For how notify & readOnly work..
            },
            useSlot: {
              type: String,
              value: "false"
            },
            startDate: String,
            endDate: String,
            breadcrumbArray: {
              type: Array,
              value: []
            },
            breadcrumbUrl: {
              type: String,
              value: "None"
            },
            breadcrumbColumn: {
              type: String,
              value: undefined
            },
            pageSize: {
              type: String,
              value: "10"
            }
        };
      }

      static get observers() {
        return ['_itemsChanged(data, page)'];
      }

      constructor() {
        super();
        this.formLookup = [];
        this.page = 0;
      }


      // Element class can define custom element reactions
      connectedCallback() {
        super.connectedCallback();
        var me = this;
        var srchBar = Polymer.dom(this.root).querySelector('#wt-srch-bar');
        me.multiSort = true;
        me.allowAdd = false;


        if (me.gridHeight == "dynamic") {
          me._resize(true);
        }

        $(window).resize(function() {
          // 1)  Get the width of the sreen
          // 2)  If minimum size of grid is not fitting drop off columns in the grid
          me._resize(true);
        });

        me.addEventListener('main-srch-field-changed', function(e){
          me._generateMainUrlAjax(e);
        });

        me.addEventListener('wt-srch-bar-changed', function(e){
          me._generateMainUrlAjax(e);
          me._resize(true);
        });

        me.addEventListener('wt-breadcrumb-clicked', function(e){
          //me._generateMainUrlAjax(null, e.detail.item.url_path);
          this.page = 0;
          me._generateColumnAjax(null,e.detail.item.url_path);
          me._resize(true);
        });


        // Take care of weird z-index problem with iron-overlay-opened and paper-dialog.
        me.$.addDialog.addEventListener('iron-overlay-opened', function(e, a, b, c) {
          var backdrop = $("iron-overlay-backdrop");
            backdrop.css('z-index', 0);
            backdrop.css('position', 'unset');
        });

        me.$.addDialog.addEventListener('iron-overlay-opened', function(e) {
          $("iron-overlay-backdrop").css('z-index', 0);
          $("iron-overlay-backdrop").css('position', 'unset');
        });

        // Take care of weird z-index problem with iron-overlay-opened and paper-dialog.
        me.$.areYouSureDialog.addEventListener('iron-overlay-opened', function(e, a, b, c) {
          var backdrop = $("iron-overlay-backdrop");
            backdrop.css('z-index', 0);
            backdrop.css('position', 'unset');
        });

        me.$.areYouSureDialog.addEventListener('iron-overlay-opened', function(e) {
          $("iron-overlay-backdrop").css('z-index', 0);
          $("iron-overlay-backdrop").css('position', 'unset');
        });

        // Save this off for later use.
        me.origColumnArray = me.columnArray.slice(0);

        // No dynamic columns -- check to see if they want to autoload the main url.
        if (me.autoLoadUrl == "true") {
          //me._generateMainUrlAjax();
          me._generateColumnAjax(null,"");
        }

      }

      ready() {
        super.ready();
      }

      _resize(reload) {
        var me = this;
        var pageBar = Polymer.dom(me.root).querySelector('#pages');
        if (me.gridHeight == "dynamic") {
          // Set the height to take the full size of the window minus the header.
          me.height = $(window).height();
          me.header = me.$.grid.getBoundingClientRect().top;
          if (typeof me.pages != 'undefined' && me.pages.length > 1) {
            me.gridSize = parseInt(me.height)- me.header - 100;
            pageBar.style.display = "block";
          } else {
            pageBar.style.display = "none";
            me.gridSize = parseInt(me.height)- me.header - 50;
          }

          me.$.grid.style = "height: "+ me.gridSize+"px";
          me.$.grid.clearCache();
          me.$.grid._gridResizeHandler();
        } else {
          me.height = me.gridHeight;
        }
      }

      _generateColumnAjax(e, urlPath) {
        var me = this;
        var columnAjax = Polymer.dom(me.root).querySelector('#column-ajax');
        columnAjax.url = me.columnArrayUrl;

        columnAjax.params['xaction'] = "get-columns";
        columnAjax.params['url_path'] = urlPath;

        var request = columnAjax.generateRequest();

        request.completes.then(function(req) {
              // Restore the original column Array
              me.columnArray = me.origColumnArray.slice(0);

              // Push the payload onto the column Array
              if (typeof req.response.payload !== 'undefined') {
                for (var i=0; i < req.response.payload.length; i++) {

                  // Use special Polymer push rather than javascripts Array.push
                  //  So that it will be an observable change to polymer and
                  //  force a re-stamp of the DOM.
                  me.push('columnArray', req.response.payload[i]);
                  me.$.grid.items = [];
                }
              }

              if (me.autoLoadUrl == "true") {
                me._generateMainUrlAjax(e,urlPath);
              }
            }, function(rejected) {
              // failed request, argument is an object
              let req = rejected.request;
              let error = rejected.error;
              console.log("FAILED",error)
              //...
            }
          );
      }

      _breadcrumbAjax(urlPath) {
        var me = this;
        var bAjax = Polymer.dom(me.root).querySelector('#breadcrumb-ajax');
        bAjax.url = me.breadcrumbUrl;

        if (typeof urlPath != 'undefined') {
          bAjax.params['xaction'] = "get-breadcrumbs";
          bAjax.params['url_path'] = urlPath;
          var request = bAjax.generateRequest();

          request.completes.then(function(req) {
                if ( req.response.success == true) {
                  if (typeof req.response.payload !== 'undefined') {
                    me.breadcrumbArray = req.response.payload
                  }
                } else {
                  // TODO:  Fix error handling to use our own wt-error object.
                  var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
                  var error = Polymer.dom(me.root).querySelector("#error-content");
                  error.innerHTML = req.response.errors[0].msg;
                  errDialog.open();
                  return;
                }
              }, function(rejected) {
                // failed request, argument is an object
                let req = rejected.request;
                let error = rejected.error;
                console.log("FAILED",error)
                //...
              }
            );
        }

      }

      _generateMainUrlAjax(e, urlPath) {
        var me = this;
        var ajax = Polymer.dom(this.root).querySelector('#ajax');
        var spinner = Polymer.dom(this.root).querySelector('#spinner');
        me._closeAllExpanded();

        if (typeof e !== 'undefined' && e != null) {
          ajax.params = e.detail.formData;
          me.srchForm = e.detail.formData;
          me.formLookup.push(e.item);
        } else {
          ajax.params = [];
        }

        ajax.params['xaction'] = "get-grid-data";
        if (typeof urlPath !== 'undefined') {
          ajax.params['url_path'] = urlPath;
        }
        me.ajax = ajax;

        // Abort in-flight ajax request if there is some
        if (typeof ajax.lastRequest !== 'undefined') {
          ajax.lastRequest.abort();
        }

        // Send off for breadcrumbs if the Url is defined.
        if (me.breadcrumbUrl !== 'None') {
          me._breadcrumbAjax(urlPath);
        }
        // See if they want dynamic columns
        // if (me.columnArrayUrl != null && typeof urlPath != 'undefined') {
        //   me._generateColumnAjax(null,urlPath);
        // }

        spinner.setAttribute("active", "");
        ajax.generateRequest();
      }

      _closeAllExpanded() {
        var me = this;
          if (typeof me.data != 'undefined' && me.data.length > 0 && me.$.grid.expandedItems.length > 0){
            me.model = {};
            me.model.item = me.$.grid.expandedItems[0];
            me._handleCancel(me);
          }
      }

      _handleAreYouSureCancel(e) {
        this.$.areYouSureDialog.close();
      }

      _handleAreYouSureSave(e) {
        var me = this;
        me._handleDelete(me.delete);
      }

      _handleCancel(e) {
        var me = this;
        var idArray = me._hideShowColumns(e.model.item, "show");
        for (var index = 0; index < me.columnArray.length; ++index) {
          var editdiv = Polymer.dom(me.root).querySelector('#'+me.columnArray[index].name+"-editdiv");
          if (editdiv != null && typeof editdiv !== 'undefined') {
            while(editdiv.hasChildNodes()) {
              editdiv.removeChild(editdiv.lastChild);
            }
          }
        }
        me.$.grid.expandedItems = [];
      }

      _handleSave(e) {
        var me = this;
        var form = Polymer.dom(me.root).querySelector('#srch-grid-iron-form');
        var formData = form.serializeForm();

        var ajaxData = e.model.item;

        if (me.useSlot == "false") {
          // Set items into the return object
          // Get rid of undefined key value pairs from grid.
          for (var key in formData) {
            if (typeof formData[key] != 'undefined') {
              // Overwrite edits from the form data.
              ajaxData[key] = formData[key];
            }
          }

        } else {
          var slot = Polymer.dom(me.root).querySelector('#custom-edit-expand-slot');
          var nodes = slot.assignedNodes();
          var form = Polymer.dom(nodes[0]).querySelector('#custom-edit-expand-slot-form');
          var formData = form.serializeForm();

          for (var key in formData) {
            if (typeof formData[key] != 'undefined') {
              // Overwrite edits from the form data.
              ajaxData[key] = formData[key];
            }
          }

          console.log("FORM DATA",formData, slot, nodes);
          for (var i=0; i < nodes.length; i++) {
            console.log("NODE",nodes[i]);
          }

        }

        var crudAjax = Polymer.dom(me.root).querySelector('#crud-ajax');
        crudAjax.url = me.url;
        ajaxData['xaction'] = 'edit';
        crudAjax.params = ajaxData;

        var request = crudAjax.generateRequest();

        request.completes.then(function(req) {
            if (req.response.success === true) {

              me._closeDialog();
              me._closeAllExpanded();
              me.$.grid.clearCache();

              var item = e.model.item;
              var newItem = $.extend(item, req.response.payload[0]);

              Array.prototype.forEach.call(Polymer.dom(me.$.grid.$.items).children, function(row) {
                if (row.item === item) {
                    me.$.grid.clearCache();
                    me.$.grid.items[row.index] = newItem;
                    me.$.grid._updateItem(row, newItem);
                }
              });

            } else {
              var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
              var error = Polymer.dom(me.root).querySelector("#error-content");
              var spinner = Polymer.dom(me.root).querySelector('#spinner');
              error.innerHTML = req.response.errors[0].msg;
              errDialog.open();
              spinner.removeAttribute("active");
              return;
            }
          }, function(rejected) {
            // failed request, argument is an object
            let req = rejected.request;
            let err = rejected.error;
            var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
            var error = Polymer.dom(me.root).querySelector("#error-content");
            var spinner = Polymer.dom(me.root).querySelector('#spinner');
            error.innerHTML = "Failed Request!";
            errDialog.open();
            spinner.removeAttribute("active");
          });


      }

      _areYouSure(e) {
        var me = this;
        me.delete = {};
        me.delete.model = e.model;
        var areYouSureDialog = me.$.areYouSureDialog;
        var message = Polymer.dom(me.root).querySelector("#are-you-sure-content");
        message.innerHTML = "Are you sure you want to delete this record? ";
        areYouSureDialog.open();
      }

      _handleDelete(e) {
        var me = this;
        var form = Polymer.dom(me.root).querySelector('#srch-grid-iron-form');
        var formData = form.serializeForm();

        var ajaxData = me.delete.model.item;

        if (me.useSlot == "false") {
          // Set items into the return object
          // Get rid of undefined key value pairs from grid.
          for (var key in formData) {
            if (typeof formData[key] != 'undefined') {
              // Overwrite edits from the form data.
              ajaxData[key] = formData[key];
            }
          }

        } else {
          var slot = Polymer.dom(me.root).querySelector('#custom-edit-expand-slot');
          var nodes = slot.assignedNodes();
          var form = Polymer.dom(nodes[0]).querySelector('#custom-edit-expand-slot-form');
          var formData = form.serializeForm();

          for (var key in formData) {
            if (typeof formData[key] != 'undefined') {
              // Overwrite edits from the form data.
              ajaxData[key] = formData[key];
            }
          }

          console.log("FORM DATA",formData, slot, nodes);
          for (var i=0; i < nodes.length; i++) {
            console.log("NODE",nodes[i]);
          }

        }

        var crudAjax = Polymer.dom(me.root).querySelector('#crud-ajax');
        crudAjax.url = me.url;
        ajaxData['xaction'] = 'delete';
        crudAjax.params = ajaxData;

        var request = crudAjax.generateRequest();

        request.completes.then(function(req) {
            if (req.response.success === true) {

              me._closeDialog();
              me._closeAllExpanded();
              me.$.grid.clearCache();

              var item = e.model.item;
              // var newItem = $.extend(item, req.response.payload[0]);

              Array.prototype.forEach.call(Polymer.dom(me.$.grid.$.items).children, function(row) {
                if (row.item === item) {
                    me.$.grid.clearCache();
                    me.$.grid.items.splice(row.index, 1);
                    var page = me.$.grid._getPageForIndex(row.index);
                    me.$.grid._loadPage(page);
                    me.$.grid.clearCache();
                    me.$.areYouSureDialog.close();
                }
              });

            } else {
              var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
              var error = Polymer.dom(me.root).querySelector("#error-content");
              var spinner = Polymer.dom(me.root).querySelector('#spinner');
              error.innerHTML = req.response.errors[0].msg;
              errDialog.open();
              spinner.removeAttribute("active");
              return;
            }
          }, function(rejected) {
            // failed request, argument is an object
            let req = rejected.request;
            let err = rejected.error;
            var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
            var error = Polymer.dom(me.root).querySelector("#error-content");
            var spinner = Polymer.dom(me.root).querySelector('#spinner');
            error.innerHTML = "Failed Request!";
            errDialog.open();
            spinner.removeAttribute("active");
          });


      }

      _handleResponse(e) {
        var me = this;
        var config = this.mainChartConfig;
        var i = 0;

        if (e.detail.response.success === true) {
          me.data = e.detail.response.payload;
          me._resize(true);
        } else {
          var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
          var error = Polymer.dom(me.root).querySelector("#error-content");
          var spinner = Polymer.dom(me.root).querySelector('#spinner');
          error.innerHTML = e.detail.response.errors[0].msg;
          errDialog.open();
          spinner.removeAttribute("active");

          return;
        }


        // Check to see if they have edit on any items in the list.
        // If they do then set Add option on.
        me.allowAdd = false;
        for(var i=0; i<me.data.length; i++) {
          if (typeof me.data[i].__edit_unique_id__ != 'undefined') {
            me.allowAdd = true;
          }
        }

        var spinner = Polymer.dom(this.root).querySelector('#spinner');
        spinner.removeAttribute("active");

      }

      _checkIfSlotExists() {
        if (this.useSlot == "true") {
          return 1;
        }
        return 0;
      }

      _checkHref(href){
        //console.log("Href: ", href);
        if(typeof href != 'undefined' && href.length > 0){
            return true;
        }
        return false;
      }

      _checkIconAction(iconAction){
        //console.log("Href: ", href);
        if(typeof iconAction != 'undefined' && iconAction.length > 0){
            return true;
        }
        return false;
      }

      _checkSort(sort){
        //console.log("Href: ", href);
        if(sorting.length > 0){
            return true;
        }
        return false;
      }

      _getItemValue(col, item){
        if(item !== null && typeof item != 'undefined'){
          if(typeof col.grid_display_field !== 'undefined' && col.grid_display_field.length > 0) {
            return item[col.grid_display_field];
          } else {
            return item[col.name];
          }
        }
      }

      _hideShowColumns(item, action) {
        var idArray = this._getUniqueColumnIds(this.columnArray,item);

        for (var index = 0; index < idArray.length; ++index) {
          var col = Polymer.dom(this.root).querySelector('#'+idArray[index]);
          if (action == "hide") {
            col.hidden = true;
          } else {
            col.hidden = false;
          }

        }
        return idArray;
      }

      _handleAddCancel() {
        var dialog = Polymer.dom(this.root).querySelector("#addDialog");
        dialog.close();
      }

      _handleErrClose() {
        var dialog = Polymer.dom(this.root).querySelector("#errorDialog");
        dialog.close();
      }

      _closeAreYouSure() {
        var dialog = Polymer.dom(this.root).querySelector("#areYouSure");
        dialog.close();
      }

      _closeDialog() {
        var dialog = Polymer.dom(this.root).querySelector("#addDialog");
        dialog.close();
      }

      _handleAdd(e) {
        var me = this;

        if (me.useSlot == "false") {
          var form = Polymer.dom(me.root).querySelector('#srch-grid-iron-form-add');
          var formData = form.serializeForm();

          var ajaxData = formData;
          // Set items into the return object
          //  NOTE:  Maybe loop over columnArray and only get those items from formData.
          //  IDEA:  Maybe we have hidden items in the columnArray -- such as the id ect.

          // Get rid of undefined key value pairs from grid.
          for (var key in formData) {
            if (typeof formData[key] != 'undefined') {
              // Overwrite edits from the form data.
              ajaxData[key] = formData[key];
            }
          }
        } else {
          var slot = Polymer.dom(me.root).querySelector('#custom-add-expand-slot');
          var nodes = slot.assignedNodes();
          var form = Polymer.dom(nodes[0]).querySelector('#custom-add-expand-slot-form');
          var formData = form.serializeForm();

          var ajaxData = formData;

          console.log("FORM DATA",formData, slot, nodes);
          for (var i=0; i < nodes.length; i++) {
            console.log("NODE",nodes[i]);
          }

        }

        var crudAjax = Polymer.dom(me.root).querySelector('#crud-ajax');
        crudAjax.url = me.url;
        ajaxData['xaction'] = 'add';
        crudAjax.params = ajaxData;

        var request = crudAjax.generateRequest();

        request.completes.then(function(req) {
            if (req.response.success === true) {
              me._closeDialog();
              me._closeAllExpanded();
              me.$.grid.clearCache();

              var item = {};
              var newItem = $.extend(item, req.response.payload[0]);

              me.$.grid.clearCache();
              me.data.splice(0,0,newItem);
              me.$.grid.clearCache();
              me.$.grid._gridResizeHandler();

              // TODO: Add a success toast here...
            } else {
              var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
              var error = Polymer.dom(me.root).querySelector("#error-content");
              var spinner = Polymer.dom(me.root).querySelector('#spinner');
              error.innerHTML = req.response.errors[0].msg;
              errDialog.open();
              spinner.removeAttribute("active");

              return;
            }

            //me.data[req.response.payload.index] = e.model.items;
          }, function(rejected) {
            // failed request, argument is an object
            let req = rejected.request;
            let err = rejected.error;
            var errDialog = Polymer.dom(me.root).querySelector("#errorDialog");
            var error = Polymer.dom(me.root).querySelector("#error-content");
            var spinner = Polymer.dom(me.root).querySelector('#spinner');
            error.innerHTML = "Failed Request!";
            errDialog.open();
            spinner.removeAttribute("active");
            //...
          });
      }

      _addClick(e) {
        var me = this;

        var dialog = Polymer.dom(me.root).querySelector("#addDialog");
        var addDiv = Polymer.dom(me.root).querySelector('#add-div');
        //$(dialog).css('z-index', 3000);
        dialog.open();

        while(addDiv.hasChildNodes()) {
          addDiv.removeChild(addDiv.lastChild);
        }

        if (me.useSlot == "false") {

          for (var index = 0; index < me.columnArray.length; ++index) {
            var item = [{}];
            var input = me._createInputObj(index, addDiv, item, false, "add");
          }
        } else {
          var slot = Polymer.dom(me.root).querySelector('#custom-add-expand-slot');
          var slotNodes = slot.assignedNodes();

          for (var index = 0; index < me.columnArray.length; ++index) {
            var editObj = Polymer.dom(slotNodes[0]).querySelector('#'+me.columnArray[index].name);
            if (me.columnArray[index].edit_type == "multi-combo") {
              editObj._clearAllItems();
            }
            if (typeof me.columnArray[index].edit_type_url != 'undefined') {
              me._generateComboRequest(editObj, index, null, item, false);
            }
          }
        }
      }

      // _reloadWithAjax(ajaxObj, column, item) {
      //   var me = this;
      //   if (me.breadcrumbUrl !== 'None') {
      //     var urlPath = item[me.breadcrumbColumn]
      //     me._breadcrumbAjax(urlPath);
      //   }
      //   var spinner = Polymer.dom(me.root).querySelector('#spinner');
      //   var request = ajaxObj.generateRequest();
      //   request.completes.then(function(req) {
      //       me.data = req.response.payload;
      //       spinner.removeAttribute("active");

      //       // Change bread crumbs here...
      //     }, function(rejected) {
      //       // failed request, argument is an object
      //       let req = rejected.request;
      //       let error = rejected.error;
      //       console.log("FAILED",error);
      //       spinner.removeAttribute("active");
      //     }
      //   );
      // }

      _iconClicked(e){
        var me = this;
        var item = e.model.item;
        var column = e.model.column;
        var spinner = Polymer.dom(me.root).querySelector('#spinner');
        spinner.setAttribute("active", "");

        me.dispatchEvent(new CustomEvent('wt-srch-grid-clicked-item', {
          bubbles: true,
          composed: true,
          item: item
        }));

        if (typeof column.icon_action !== 'undefined' && column.icon_action.length > 0) {
          var paramStr = me._getParams(column,item);
          var iconAjax = Polymer.dom(me.root).querySelector('#icon-ajax');
          iconAjax.url = column.icon_action;
          iconAjax.url += "?xaction=get-"+item.icon+"&"+paramStr;
          if (item.icon == 'file-download') {
            window.open(iconAjax.url);
            spinner.removeAttribute("active","download.pdf");
          } else {
            if (me.breadcrumbUrl !== 'None') {
              var urlPath = item[me.breadcrumbColumn]
              me._generateColumnAjax(null,urlPath);
            }
          }

        }
      }

      _editClick(e){
        var me = this;
        var item = e.model.item;

        // TODO:  Do a quick AJAX call here to get the most updated record/item???
        //        Others may have modified the record if it has been sitting in the list too long...

        // Close any expanded Items first
        if (typeof me.$.grid.expandedItems[0] !== 'undefined'
            && me.$.grid.expandedItems.length > 0) {
          me.model = {};
          me.model.item = me.$.grid.expandedItems[0];

          me._handleCancel(me);
          me.$.grid.clearCache();
          me.$.grid._gridResizeHandler();
          me.$.grid.expandedItems = [];

          // Needed this short timeout in order to simulate edit click.
          var timer = setTimeout(function(){
            window.clearTimeout(timer);
            me._editClick(e);
          }, 5);
          return;
        }

        me.$.grid.expandedItems = [item];
        var idArray = me._hideShowColumns(item, "hide");

        if (me.useSlot == "false") {
          // No custom expand slot found.
          // Lets add & layout the form ourselves -- based on the columnArray info
          for (var index = 0; index < me.columnArray.length; ++index) {

                var editdiv = Polymer.dom(me.root).querySelector('#'+me.columnArray[index].name+"-editdiv");

                // Add css bootstrap class if it exists
                if (typeof me.columnArray[index].edit_bootstrap_class != 'undefined') {
                  $(editdiv).removeClass("col-md-4");
                  $(editdiv).addClass(me.columnArray[index].edit_bootstrap_class);
                }
                me._createInputObj(index, editdiv, item, true, "edit");
          }
        } else {
          // Use the custom slot that they have provided.
          me.$.grid.expandedItems = [item];
          var slot = Polymer.dom(me.root).querySelector('#custom-edit-expand-slot');
          var slotNodes = slot.assignedNodes();
          for (var index = 0; index < me.columnArray.length; ++index) {
            var editObj = Polymer.dom(slotNodes[0]).querySelector('#'+me.columnArray[index].name);
            editObj.value = item[me.columnArray[index].name];
            if (me.columnArray[index].edit_type == "multi-combo") {
              editObj._clearAllItems();
            }
            if (typeof me.columnArray[index].edit_type_url != 'undefined') {
              me._generateComboRequest(editObj, index, null, item, false);
            }
          }
        }

        var grid = Polymer.dom(me.root).querySelector('#grid');
        grid._gridResizeHandler();
      }

      _createInputObj(index, editdiv, item, preload, mode) {
        var me = this;
        var switchStr = me.columnArray[index].edit_type;

        // Check columnArray to see if we need to go 'readonly' on any of the columns
        // based on the "addmode" / "editmode" attributes.
        if (mode === "add" && me.columnArray[index].addmode === "readonly") {
          switchStr = "readonly";
        } else if (mode === "edit" && me.columnArray[index].editmode === "readonly") {
          switchStr = "readonly";
        }

        // TODO:  We could implement field level security here...
        //        Based on flags sent from the server.
        //        Example:  "phone_number" could have another field called
        //                  "phone_number__readonly" which could be it's flag for readonly.

        switch(switchStr) {
            case 'multi-combo':
                var combo = document.createElement('wt-vaadin-multi-combo');
                combo.label = "Select "+me.columnArray[index].description+"(s)";
                combo.name = me.columnArray[index].name;
                me._generateComboRequest(combo, index, editdiv, item, preload);
                combo.addEventListener('value-changed', function(e) {
                  var grid = Polymer.dom(me.root).querySelector('#grid');
                  grid._gridResizeHandler();
                });
                break;
            case 'combo':
                var combo = document.createElement('vaadin-combo-box');
                combo.label = "Select "+me.columnArray[index].description+"";
                combo.name = me.columnArray[index].name;
                me._generateComboRequest(combo, index, editdiv, item, preload);
                break;
            case 'input':
                var input = document.createElement('paper-input');
                input.label = "Enter "+me.columnArray[index].description+"";
                input.name = me.columnArray[index].name;
                if (preload) {
                    input.value = item[me.columnArray[index].name];
                }
                $(editdiv).append(input);
                break;
            case 'textarea':
                var input = document.createElement('paper-textarea');
                input.label = "Enter "+me.columnArray[index].description+"";
                input.name = me.columnArray[index].name;
                if (preload) {
                  input.value = item[me.columnArray[index].name];
                }
                break;
            default:
                var input = document.createElement('paper-input');
                input.readonly = true;
                input.label = "Enter "+me.columnArray[index].description+"";
                input.name = me.columnArray[index].name;
                if (preload) {
                  input.value = item[me.columnArray[index].name];
                }
                $(editdiv).append(input);
              }
            if (typeof input === 'undefined') {
              return combo;
            }
            return input;
      }

      _generateComboRequest(combo, index, editdiv, item, preload) {
        var me = this;
        var editAjax = Polymer.dom(me.root).querySelector('#edit-ajax');
        editAjax.url = me.columnArray[index].edit_type_url;

        //if (typeof me.columnArray[index].comboItems == 'undefined') {
          var request = editAjax.generateRequest();

          request.completes.then(function(req) {
              combo.itemLabelPath = "label";
              combo.itemValuePath = "value";
              combo.style = "padding: 3px 3px 20px 3px; white-space: none;"
              combo.items = req.response.payload;
              if (preload) {
                combo.value = item[me.columnArray[index].name];
              }
              me.columnArray[index].comboItems = combo.items;
              if (me.useSlot == "false") {
                $(editdiv).append(combo);
              }
            }, function(rejected) {
              // failed request, argument is an object
              let req = rejected.request;
              let error = rejected.error;
              console.log("FAILED",error)
              //...
            }
          );
        // } else {
        //   // Get the cached lookup.
        //   combo.itemLabelPath = "label";
        //   combo.itemValuePath = "value";
        //   combo.style = "padding: 3px 3px 20px 3px; white-space: none;";
        //   combo.items = me.columnArray[index].comboItems;
        //   combo.value = item[me.columnArray[index].name];
        //   if (me.useSlot == "false") {
        //     $(editdiv).append(combo);
        //   }
        // }

      }

      _getUniqueColumnIds(columnArray,item) {
        var uniqueColumnIds = [];
        for (var index = 0; index < columnArray.length; ++index) {
            uniqueColumnIds.push(columnArray[index].name+"-"+item.__edit_unique_id__);
        }
        //Also push on the edit button
        uniqueColumnIds.push("edit-"+item.__edit_unique_id__)
        return uniqueColumnIds;
      }

      // TODO: URLencode the return string
      _getParams(column, item){
        if(item !== null && typeof item != 'undefined'){
            var returnString = "";
            for (var key in column.params) {
                if (column.params.hasOwnProperty(key)) {
                    returnString += key + "=" + item[column.params[key]] + "&";
                }
            }
            return returnString;
        }
      }


      _getHashPath(column, item){
      	if(typeof column.hashpath != 'undefined') {
            if(item !== null && typeof item != 'undefined'){
                var returnString = "";
                var hashColumns = column.hashpath.split('#-');

                for (var key in hashColumns) {
                  var val = hashColumns[key];
                  var re = new RegExp('-#', 'gi');
                  if (val.match(re)) {
                    var k = val.split('-#');
                    var val = item[k[0]];
                  }
                  returnString += val;
                }
                return returnString;
            }
          }
        }


      _isSelected(page, item) {
        return page === item - 1;
      }

      _select(e) {
        this.page = e.model.item - 1;
      }

      _next() {
        this.page = Math.min(this.pages.length - 1, this.page + 1);
      }

      _prev() {
        this.page = Math.max(0, this.page - 1);
      }

      _itemsChanged(items, page) {
        if (items === undefined || page === undefined) {
          return;
        }

        //if (!this.pages) {
          this.pages = Array
            .apply(null, {length: Math.ceil(items.length / this.$.grid.pageSize)}).map((item, index) => index + 1);
        //}

        const start = page * this.$.grid.pageSize;
        const end = (page + 1) * this.$.grid.pageSize;
        this.$.grid.items = items.slice(start, end);
      }

    }

    window.customElements.define(WtSrchGrid.is, WtSrchGrid);
  </script>
</dom-module>
